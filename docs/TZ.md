# Техническое задание: Telegram-бот с мини-приложением (Prime Hill, розыгрыш, магазин)

Дата: 17.02.2025  
Формат дат в системе: dd.mm.yyyy  
Язык интерфейса: русский.

---

## 1. Общие сведения

### 1.1 Цель
Интеграция бонусной системы Prime Hill (loyaltyAPI + openAPI) с Telegram-ботом: авторизация по карте/телефону, получение и списание бонусов в мини-приложении (розыгрыш, магазин), обращения пользователей, администрирование через веб-админку и дублирование заявок в Telegram-супергруппу.

### 1.2 Ссылки
- loyaltyAPI (Касса/Фронт): https://api.prime-hill.com/loyaltyApi/
- openAPI (Бэкенд/CRM): https://api.prime-hill.com/openApi/
- Доступ к API: токены для обоих API должны быть в конфиге.

---

## 2. Telegram-бот

### 2.1 Старт и меню
- Команда /start — кнопка «Начать».
- Главное меню: две кнопки — **«Оставить обращение»** и **«Потратить бонусы»**.

### 2.2 Потратить бонусы
- Открывает Telegram Mini App (React, свой домен, SSL).
- Доступ в мини-приложение только после авторизации (привязка Prime Hill). Если у пользователя нет аккаунта — регистрация через openAPI Prime Hill.

### 2.3 Оставить обращение
- Бот отправляет: «Отправьте ваше сообщение ниже, мы постараемся ответить как можно скорее».
- Пользователь выбирает **категорию** обращения и вводит текст.
- Обращение создаёт **тикет** в Telegram-супергруппе (одно обращение = одна тема/топик). Двусторонняя связь: сообщения из бота пересылаются в тему, ответы из темы — в бот. FleepBot не используется.
- Категории обращений: уточняемый список (например: «Вопрос по заказу», «Жалоба», «Сотрудничество», «Другое»).

### 2.4 Админы
- Список админов хранится в БД. Добавление/удаление админов — через веб-админку (метод с референса). По умолчанию в конфиге предусмотреть ID 7533811917; поддержка нескольких админов обязательна.

---

## 3. Мини-приложение (React)

Два раздела: **Розыгрыш** и **Магазин**. Общая корзина (товары из магазина + выигранный товар с оплатой промокодом 0 ₽).

### 3.1 Авторизация в мини-приложении
- При первом заходе в «Потратить бонусы» — экран привязки: ввод номера карты лояльности **или** номера телефона (на выбор пользователя).
- Запрос к loyaltyAPI Prime Hill (`GuestInfo`): получение баланса бонусов. При отсутствии аккаунта — регистрация через openAPI (`createClients`).
- Один аккаунт Prime Hill = один пользователь бота; возможность отвязать и привязать другой номер/карту.

---

## 4. Структура страниц мини-приложения

*(Подробно — в документе `TZ_Mini_App.md` в этой же папке.)*

### 4.1 Общая навигация
- **Нижняя плашка корзины** (если в корзине есть товары): счётчик позиций + текст «Перейти в корзину / Заказ» — всегда внизу экрана, ведёт на страницу корзины.

### 4.2–4.8 Главная, Розыгрыш, Магазин, Корзина, Оформление
См. **TZ_Mini_App.md**.

---

## 5. Веб-админка

Назначение: управление товарами, розыгрышами, призами, настройками спинов, ролями, просмотр заказов и обращений. Заявки дублируются в Telegram-супергруппу.

*(Подробно — в документе `TZ_Web_Admin.md` в этой же папке.)*

---

## 6. Дублирование заявок в Telegram

- **Заказы:** при создании заказа — заявка в веб-админке и сообщение/тема в супергруппе.
- **Обращения:** одно обращение = одна тема в супергруппе. Двусторонняя связь.

---

## 7. Интеграции и технические требования

| Компонент | Требование |
|-----------|------------|
| **Prime Hill API** | loyaltyAPI: Авторизация, баланс (`GuestInfo`). openAPI: Регистрация (`createClients`), списание (`createOrder`). |
| ЮKassa | Оплата рублями (остаток после бонусов). Смешанная оплата: сначала бонусы, потом рубли |
| Доставка | Без интеграции со службами: адрес текстом, курьер / самовывоз |
| Логирование | Разные уровни логов — в разные файлы |
| Резервное копирование БД | По регламенту |
| Даты | Формат dd.mm.yyyy везде в системе |

---

## 8. Уточнения по розыгрышу (логика)

- **Глобальный счётчик:** в БД — число оставшихся спинов до гарантированного выигрыша. После каждой прокрутки счётчик уменьшается. При 0 — следующий спин даёт главный выигрыш.
- **До главного выигрыша:** выигрыши по вероятностям призов.
- **После главного выигрыша:** розыгрыш завершается; в админке — «Повторить» или «Создать новый».

---

## 9. Связанные документы

Все документы ТЗ находятся в папке **docs/**:

| Документ | Описание |
|----------|----------|
| `TZ.md` | Общее ТЗ (этот документ) |
| `README_TZ.md` | Оглавление комплекта ТЗ |
| `TZ_Backend.md` | ТЗ бэкенда: API, интеграции, логирование |
| `DB_Schema.md` | Схема БД PostgreSQL |
| `TZ_Frontend.md` | ТЗ фронтенда: стек, маршруты, компоненты |
| `TZ_Mini_App.md` | Страницы мини-приложения |
| `TZ_Web_Admin.md` | Страницы веб-админки |

---

**Перейти к следующему документу:** `DB_Schema.md` — схема базы данных.
