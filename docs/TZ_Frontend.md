# ТЗ: Фронтенд

Отдельный документ с подробным техническим заданием на разработку клиентской части.  
Связанные документы: `TZ.md`, `TZ_Mini_App.md`, `TZ_Web_Admin.md`, `TZ_Backend.md`, `DB_Schema.md` (в этой же папке docs/).  
Язык интерфейса: русский. Формат дат: dd.mm.yyyy.

---

## 1. Общая структура фронтенда

Два независимых приложения:

| Приложение | Назначение | Стек | Домен |
|------------|------------|------|-------|
| **Mini App** | Telegram Mini App (розыгрыш, магазин, корзина) | React | Отдельный поддомен, SSL |
| **Web Admin** | Веб-админка (товары, розыгрыши, заказы, обращения) | React | Отдельный поддомен, SSL |

Общие требования: TypeScript, адаптивная вёрстка (Web Admin — десктоп в приоритете; Mini App — мобильные устройства).

---

## 2. Мини-приложение (React)

### 2.1 Технологический стек

| Компонент | Технология | Примечание |
|-----------|------------|------------|
| Фреймворк | React 18+ | — |
| Язык | TypeScript | Строгая типизация |
| Сборка | Vite | Быстрая разработка и сборка |
| Маршрутизация | React Router v6 | — |
| Состояние | React Query (TanStack Query) + Context/Zustand | Кэш API, глобальное состояние (корзина, пользователь) |
| HTTP-клиент | axios или fetch | Запросы к API |
| Стили | CSS Modules / Tailwind CSS / styled-components | На усмотрение команды |
| Telegram Web App | @telegram-apps/sdk-react или window.Telegram.WebApp | Инициализация, initData, закрытие |

### 2.2 Инициализация и авторизация

- При загрузке приложения: чтение `window.Telegram.WebApp.initData` и передача в заголовке `X-Telegram-Init-Data` (или `Authorization`) при запросах к API.
- Проверка привязки Tezo: запрос `GET /api/v1/miniapp/auth/me`. Если `tezo_bound: false` — редирект на `/auth`.
- После успешной привязки — сохранение флага в состоянии, доступ ко всем разделам.

### 2.3 Структура страниц и маршрутов

| Путь | Компонент | Описание |
|------|-----------|----------|
| `/` | MainPage | Главная: кнопки Розыгрыш, Магазин, баланс бонусов |
| `/auth` | AuthPage | Привязка Tezo (карта/телефон) |
| `/raffle` | RafflePrizesPage | Список призов, карточки с кнопкой «Играть» |
| `/raffle/play` | RafflePlayPage | Слот-машина, спин, результат |
| `/shop` | ShopCatalogPage | Каталог товаров, карточки, добавление в корзину |
| `/cart` | CartPage | Корзина, изменение количества, «Оплатить» |
| `/checkout` | CheckoutPage | Адрес, доставка, промокод, оплата |

### 2.4 Глобальные компоненты

| Компонент | Описание |
|-----------|----------|
| **CartBar** | Нижняя плашка корзины. Показывается, если в корзине есть позиции. Фиксирована внизу. Клик — переход на `/cart`. |
| **Layout** | Обёртка страниц: шапка (если нужна), контент, CartBar. |

### 2.5 Интеграция с API

- Базовый URL API из конфига (переменная окружения при сборке).
- Все запросы с заголовком `X-Telegram-Init-Data` (initData от Telegram).
- Обработка ошибок: тосты/уведомления (например, react-hot-toast). При 401 — редирект на `/auth`.

### 2.6 Специфичные экраны

**Розыгрыш — слоты:**
- Анимация вращения: CSS или библиотека (framer-motion). Три ячейки, каждая крутится и останавливается по очереди.
- Результат спина приходит с бэкенда: массив символов (например, `["emoji", "product_id", "emoji"]`). Отображение: эмодзи или изображение товара по product_id.

**Экран выигрыша:**
- Модальное окно или полноэкранный оверлей. Анимация салюта (CSS keyframes или простая библиотека). Кнопка «К оформлению» — переход на `/cart`.

**Корзина:**
- Счётчики количества: кнопки − и +, вызов `PATCH /cart/items/:id` с новым quantity. Оптимистичное обновление UI.

### 2.7 Сборка и деплой

- `npm run build` — выход в `dist/`.
- Деплой на статический хостинг (Nginx, S3 + CloudFront, Vercel и т.д.).
- Домен с SSL. URL Mini App передаётся в настройки Telegram Bot (BotFather).

---

## 3. Веб-админка (React)

### 3.1 Технологический стек

| Компонент | Технология | Примечание |
|-----------|------------|------------|
| Фреймворк | React 18+ | — |
| Язык | TypeScript | — |
| Сборка | Vite | — |
| Маршрутизация | React Router v6 | — |
| Состояние | React Query + Context/Zustand | Кэш API, пользователь, роли |
| HTTP-клиент | axios | С interceptors для JWT |
| UI-библиотека | Ant Design / MUI / shadcn/ui | Таблицы, формы, модалки |
| Загрузка файлов | input type=file + FormData | Отправка на `/upload/image` |

### 3.2 Авторизация

- Страница входа: `/login` (логин/пароль или Telegram-авторизация).
- После успешного входа — сохранение JWT в localStorage (или httpOnly cookie, если бэкенд отдаёт cookie).
- Защищённые маршруты: проверка наличия токена; при 401 — редирект на `/login`.
- Меню: отображение пунктов в соответствии с правами пользователя (роли).

### 3.3 Структура страниц и маршрутов

| Путь | Компонент | Описание |
|------|-----------|----------|
| `/login` | LoginPage | Вход |
| `/` или `/admin` | DashboardPage | Главная: виджеты, быстрые ссылки |
| `/admin/raffle` | RafflePage | Розыгрыш: состояние, прогресс-бар, список призов |
| `/admin/raffle/prizes/new` | RafflePrizeFormPage | Добавление приза |
| `/admin/raffle/prizes/:id` | RafflePrizeFormPage | Редактирование приза |
| `/admin/shop` | ShopCatalogPage | Каталог товаров, таблица/сетка |
| `/admin/shop/new` | ProductFormPage | Добавление товара |
| `/admin/shop/:id` | ProductCardPage | Карточка товара: просмотр и редактирование |
| `/admin/orders` | OrdersPage | Список заказов, детали |
| `/admin/appeals` | AppealsPage | Список обращений, переписка |
| `/admin/users` | UsersPage | Админы бота, роли |

### 3.4 Общая разметка

- **Layout:** боковое меню (или верхняя навигация) + область контента.
- **Шапка:** логотип, название, имя пользователя, кнопка «Выход».
- **Меню:** Главная, Розыгрыш, Магазин, Заказы, Обращения, Пользователи и роли. Скрытие пунктов по правам.
- **Хлебные крошки:** при углублении (например, Магазин → Название товара).

### 3.5 Раздел «Магазин» — детали

**Каталог (`/admin/shop`):**
- Таблица: колонки — превью, название, цены, скидка, в розыгрыше, остаток, действия.
- Фильтры: поиск по названию, «Участвует в розыгрыше», «В наличии», сортировка.
- Кнопка «Добавить товар» → `/admin/shop/new`.
- Клик по строке/названию → `/admin/shop/:id`. Кнопка «Удалить» с подтверждением.

**Карточка товара (`/admin/shop/:id`):**
- Режимы: просмотр и редактирование. Кнопка «Редактировать» переключает режим.
- Блок изображений: основное + галерея. В режиме редактирования — загрузка (выбор файла → POST `/upload/image` → получение URL → отображение в форме). Удаление — DELETE `/upload/image` + обновление формы.
- Поля: название, есть размеры, список размеров, цены, скидка %, в розыгрыше, остаток.
- Кнопки: Сохранить, Отмена, Удалить товар (с подтверждением).

**Новый товар (`/admin/shop/new`):**
- Та же форма, что в карточке, но пустая. После сохранения — редирект на `/admin/shop/:id` созданного товара.

### 3.6 Раздел «Розыгрыш»

- Блок состояния: статус, прогресс-бар (спинов до выигрыша), настройка лимита.
- Список призов: таблица/карточки, кнопки «Изменить», «Удалить».
- Форма приза: изображение (S3), название, размеры, цена в бонусах, вероятность. Загрузка изображения через `/upload/image`.

### 3.7 Заказы и обращения

- Таблицы с фильтрами. Клик по строке — открытие деталей (модальное окно или отдельная панель).
- Обращения: переписка в хронологическом порядке, поле ввода ответа, кнопка «Отправить».

### 3.8 Сборка и деплой

- `npm run build` → `dist/`.
- Деплой на статический хостинг. Проксирование API через Nginx (или CORS с бэкенда).

---

## 4. Общие требования к фронтенду

### 4.1 Форматирование дат

- Везде отображать даты в формате **dd.mm.yyyy** (при необходимости — dd.mm.yyyy HH:mm).
- Использовать `Intl.DateTimeFormat` или библиотеку (date-fns, dayjs) с локалью `ru-RU`.

### 4.2 Обработка ошибок

- Сетевые ошибки: показ сообщения пользователю (тост, alert, inline).
- Валидация форм: сообщения под полями (required, format, range).

### 4.3 Доступность (a11y)

- Семантическая разметка (header, main, nav, button, input).
- Подписи к полям (label), aria-атрибуты при необходимости.
- Фокус при навигации с клавиатуры.

### 4.4 Производительность

- Ленивая загрузка страниц (React.lazy, Suspense) для тяжёлых разделов.
- Оптимизация изображений: использование URL с S3 (ресайз на бэкенде или CDN при необходимости).

---

## 5. Конфигурация и переменные окружения

**Mini App:**
```
VITE_API_BASE_URL=https://api.example.com
VITE_MINIAPP_TITLE=Название приложения
```

**Web Admin:**
```
VITE_API_BASE_URL=https://api.example.com
```

Секреты (JWT, ключи) не хранить во фронтенде. Авторизация — через бэкенд.

---

**Перейти к следующему документу:** `TZ_Mini_App.md` — страницы мини-приложения (затем `TZ_Web_Admin.md` — веб-админка).
