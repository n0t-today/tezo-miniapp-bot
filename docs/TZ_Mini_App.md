# ТЗ: Мини-приложение (Telegram Mini App)

Отдельный документ с подробным описанием каждой страницы мини-приложения.  
Общее ТЗ — в файле `TZ.md` (в этой же папке docs/).  
Язык интерфейса: русский. Формат дат: dd.mm.yyyy.

---

## Технический контекст

- **Стек:** React.
- **Доступ:** только после авторизации (привязка Prime Hill по номеру карты или телефона).
- **Хостинг:** свой домен, SSL (обязательно для Mini App).
- **Изображения товаров:** отдаются с S3 (настройка в бэкенде/админке).

---

## Глобальные элементы (на всех страницах)

### Нижняя плашка корзины
- **Условие показа:** отображается на всех страницах, если в корзине есть хотя бы одна позиция.
- **Содержимое:** иконка корзины, число позиций (или число товаров), текст «Перейти в корзину» / «В заказ».
- **Действие:** клик ведёт на страницу корзины (`/cart`).
- **Расположение:** фиксировано внизу экрана (не перекрывает основной контент; при скролле контент учитывает высоту плашки).

---

## Страница 1. Авторизация (привязка Prime Hill)

**Путь:** `/auth` или показ при первом заходе без привязки.

**Назначение:** привязка аккаунта Prime Hill для получения и списания бонусов.

| Блок | Описание |
|------|----------|
| Заголовок | «Привязка бонусной карты» или «Вход» |
| Выбор способа | Переключатель или две кнопки: «По номеру карты» / «По номеру телефона» |
| Поле ввода | В зависимости от выбора: номер карты лояльности или номер телефона (маска/валидация по формату loyaltyAPI) |
| Кнопка | «Привязать» / «Войти» — запрос к loyaltyAPI (получение баланса или регистрация через openAPI, если метода нет в системе) |
| Сообщения | Успех: переход в мини-апп (главная). Ошибка: текст ошибки под формой (карта не найдена, нужна регистрация и т.д.) |
| Дополнительно | Ссылка «Отвязать карту» на последующих сессиях — в настройках/профиле внутри приложения (при наличии такого экрана) |

---

## Страница 2. Главная

**Путь:** `/` или `/main`

**Назначение:** выбор раздела — Розыгрыш или Магазин.

| Блок | Описание |
|------|----------|
| Шапка | Логотип/название приложения (при наличии) |
| Баланс бонусов | Блок с текущим балансом бонусов (обновляется при заходе и после списаний) |
| Кнопка | **«Розыгрыш»** — переход на `/raffle` |
| Кнопка | **«Магазин»** — переход на `/shop` |
| Нижняя плашка | Корзина (если есть товары) — см. глобальные элементы |

---

## Страница 3. Розыгрыш — список призов

**Путь:** `/raffle` или `/raffle/prizes`

**Назначение:** выбор приза и участие в слот-игре за 20 бонусов за спин.

| Блок | Описание |
|------|----------|
| Кнопка «Назад» | Возврат на главную (`/`) |
| Заголовок | «Розыгрыш» |
| Подсказка | Текст вида: «Участие — 20 бонусов за спин» |
| Список карточек | Горизонтальный скролл или сетка карточек призов |

**Карточка приза (каждая):**
- Фото товара (изображение с S3).
- Название товара.
- Размеры: если у товара есть размеры — выпадающий список `<select>` со всеми вариантами; обязательный выбор перед нажатием «Играть».
- Цена участия: текст «20 бонусов».
- Кнопка **«Играть»**.  
  **Валидация:** при наличии размеров размер должен быть выбран; иначе — сообщение «Выберите размер» (тост/под полем).

---

## Страница 4. Розыгрыш — игра (слоты)

**Путь:** `/raffle/play` (query-параметр приза, например `?prizeId=...`)

**Назначение:** спин слотов; выигрыш по трём одинаковым символам в ряд или по глобальному счётчику.

| Блок | Описание |
|------|----------|
| Кнопка «Назад» | Возврат на список призов (`/raffle`) без списания бонусов (если спин ещё не начат) |
| Название приза | Отображается выбранный приз (и размер, если был) |
| Слот-машина | Три ячейки в ряд. При прокрутке показываются символы: изображения товаров (призы) и смайлики (пустые ячейки). Анимация вращения, затем остановка по очереди |
| Кнопка «Играть снова» | Доступна после завершения спина. При нажатии — проверка баланса (≥ 20 бонусов), списание 20 бонусов через openAPI (`createOrder`), новый спин |
| Баланс | Текущий баланс бонусов после спина (обновить с сервера) |

**Логика выигрыша:**
- До срабатывания глобального счётчика: результат по вероятностям призов (определяется бэкендом).
- При достижении глобального счётчика (N спинов): следующий спин — гарантированный главный выигрыш.
- Выигрыш: три одинаковых товара в ряд (или условие от бэкенда). При выигрыше — переход на экран выигрыша (модальное окно или отдельный экран).

---

## Страница 5. Розыгрыш — экран выигрыша

**Показ:** поверх слотов (модальное окно или полноэкранный оверлей) после выигрыша.

| Блок | Описание |
|------|----------|
| Анимация | Салют / лучи света (CSS или лёгкая анимация) |
| Текст | «Поздравляем! Вы выиграли [название товара]» |
| Действие системы | Товар автоматически добавляется в корзину с ценой 0 ₽; пользователю выдаётся промокод для оплаты этой позиции при оформлении (промокод показывается на экране и/или сохраняется в заказе) |
| Кнопка | **«К оформлению»** — закрытие экрана выигрыша и переход на страницу корзины (`/cart`) |

---

## Страница 6. Магазин — каталог

**Путь:** `/shop` или `/shop/catalog`

**Назначение:** просмотр товаров и добавление в корзину.

| Блок | Описание |
|------|----------|
| Кнопка «Назад» | Возврат на главную (`/`) |
| Заголовок | «Магазин» |
| Список товаров | Сетка или список карточек товаров (только товары «в наличии», если в админке ведётся остаток) |

**Карточка товара в каталоге:**
- Фото товара (URL с S3).
- Название товара.
- Размеры: при наличии — `<select>` с вариантами размеров; обязательный выбор перед добавлением в корзину.
- Цена: в бонусах и в рублях (с учётом скидки в %, если задана в админке).
- Кнопка **«В корзину»**.  
  После добавления на месте кнопки отображается **счётчик количества** (минус / значение / плюс) для этой позиции (товар + выбранный размер). Добавление того же товара с другим размером создаёт отдельную позицию в корзине.  
- **Валидация:** при наличии размеров кнопка «В корзину» не добавляет товар без выбранного размера — показ сообщения «Выберите размер».

---

## Страница 7. Корзина

**Путь:** `/cart`

**Назначение:** просмотр позиций, изменение количества, переход к оформлению заказа.

| Блок | Описание |
|------|----------|
| Кнопка «Удалить всё» | Очистка корзины с подтверждением («Удалить все товары?» — Да / Нет) |
| Кнопка «В каталог» | Возврат в магазин (`/shop`) |
| Список позиций | Для каждой позиции: фото (S3), название, выбранный размер (если есть), количество (изменить минус/плюс), цена в бонусах и/или рублях. Позиция с ценой 0 ₽ — выигранный товар; при оформлении к ней применяется выданный промокод (поле может быть уже подставлено) |
| Блок внизу | Текущий баланс бонусов; итоговая сумма к оплате бонусами; итоговая сумма к оплате рублями (если есть остаток после бонусов) |
| Кнопка «Оплатить» | Переход на страницу оформления заказа (`/checkout`). На кнопке отобразить краткий итог: например «Оплатить X бонусов и Y ₽» |

**Оплата (логика):** сначала списание бонусов (openAPI `createOrder`), остаток — рублями через ЮKassa. Выигранный товар (0 ₽) оформляется по промокоду без списания бонусов/денег за эту позицию.

---

## Страница 8. Оформление заказа

**Путь:** `/checkout`

**Назначение:** ввод адреса и способа доставки, применение промокода для выигранного товара, оплата рублёвой части.

| Блок | Описание |
|------|----------|
| Краткое напоминание | Состав заказа (позиции, итог бонусами и рублями) |
| Поле | **Адрес доставки** — текст (без интеграции со службами доставки). Обязательное при доставке курьером |
| Поле | **Способ доставки:** переключатель «Курьер» / «Самовывоз» (при самовывозе адрес может быть необязательным или упрощённым) |
| Поле (при необходимости) | **Комментарий к заказу** — необязательно |
| Блок промокода | Если в корзине есть позиция 0 ₽ (выигранный товар): поле ввода промокода (или автоматическая подстановка выданного промокода, только для отображения). Валидация промокода перед отправкой заказа |
| Итог | Сумма к списанию бонусами; сумма к оплате рублями (если есть). Кнопка «Оплатить» для рублёвой части ведёт на ЮKassa (redirect или виджет) |
| Кнопка «Подтвердить заказ» | При оплате только бонусами и промокодом — отправка заказа без перехода в ЮKassa. После успешного создания заказа — сообщение об успехе и редирект (например, на главную или в корзину с очисткой). Заявка создаётся в веб-админке и дублируется в Telegram-супергруппу |

---

## Навигация и состояния

- Все переходы «Назад» ведут на предыдущий экран (или главную для разделов Розыгрыш/Магазин).
- После выигрыша пользователь попадает в корзину с добавленным призом и может сразу перейти в оформление или продолжить покупки.
- Состояние корзины и баланс бонусов должны быть согласованы с бэкендом (при необходимости — обновление при возврате на экран из другого раздела).

---

## Валидации (сводка)

| Страница | Проверка |
|----------|----------|
| Авторизация | Формат номера карты/телефона; ответ loyaltyAPI |
| Розыгрыш — список | Выбор размера перед «Играть» (если размеры есть) |
| Розыгрыш — игра | Баланс ≥ 20 бонусов перед спином |
| Магазин — каталог | Выбор размера перед «В корзину» (если размеры есть) |
| Корзина | Наличие хотя бы одной позиции перед переходом в оформление |
| Оформление | Адрес при доставке курьером; валидный промокод для позиции 0 ₽ |

---

**Перейти к следующему документу:** `TZ_Web_Admin.md` — страницы веб-админки.
