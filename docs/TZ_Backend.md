# ТЗ: Бэкенд

Отдельный документ с подробным техническим заданием на разработку серверной части.  
Связанные документы: `TZ.md`, `TZ_Mini_App.md`, `TZ_Web_Admin.md`, `DB_Schema.md`.  
Язык интерфейса: русский. Формат дат: dd.mm.yyyy.

---

## 1. Общая архитектура

### 1.1 Компоненты системы

| Компонент | Назначение |
|-----------|------------|
| **API-сервер** | REST API для мини-приложения и веб-админки; вебхуки (ЮKassa, при необходимости) |
| **Telegram-бот** | Обработка команд и сообщений; интеграция с API; пересылка в супергруппу |
| **Интеграции** | Tezo API, ЮKassa, S3, Telegram Bot API |
| **БД** | PostgreSQL (см. `DB_Schema.md`) |
| **Очереди/фоновые задачи** | Опционально: Celery, Redis — для отложенных задач (отправка в ТГ, синхронизация) |

### 1.2 Рекомендуемый стек

| Слой | Технология | Примечание |
|------|------------|------------|
| Язык | Python 3.11+ | — |
| Фреймворк API | FastAPI | Асинхронность, автодокументация OpenAPI |
| ORM | SQLAlchemy 2.x (async) + Alembic | Миграции БД |
| Telegram-бот | aiogram 3.x | Асинхронный |
| HTTP-клиент | httpx (async) | Запросы к Tezo, ЮKassa |
| S3 | boto3 | Загрузка/удаление файлов |
| Логирование | structlog или logging | Разные уровни в разные файлы |
| Конфигурация | Pydantic Settings | Без env в коде (конфиг-файл или переменные окружения на сервере) |

---

## 2. API для мини-приложения

**Базовый путь:** `/api/v1/miniapp` (или `/api/miniapp`).  
**Авторизация:** проверка `initData` от Telegram Web App (валидация подписи) + привязка Tezo. Пользователь идентифицируется по `telegram_user_id` из initData.

### 2.1 Авторизация и привязка Tezo

| Метод | Путь | Описание | Тело запроса | Ответ |
|-------|------|----------|--------------|-------|
| POST | `/auth/bind` | Привязка карты/телефона к пользователю | `{ "type": "card" \| "phone", "value": "..." }` | `{ "success": true, "balance": 100 }` или ошибка |
| POST | `/auth/unbind` | Отвязка Tezo | — | `{ "success": true }` |
| GET | `/auth/me` | Текущий пользователь, привязка, баланс | — | `{ "telegram_user_id": ..., "tezo_bound": true, "balance": 100 }` |

**Логика `/auth/bind`:**
1. Валидация initData (Telegram).
2. Запрос к Tezo API: получение баланса по карте/телефону (или регистрация, если метод есть).
3. Сохранение привязки в БД (`tezo_bindings`).
4. Возврат баланса.

### 2.2 Товары и каталог

| Метод | Путь | Описание | Параметры | Ответ |
|-------|------|----------|-----------|-------|
| GET | `/products` | Список товаров магазина (в наличии) | `?in_raffle=true` — только в розыгрыше | `{ "items": [...], "total": N }` |
| GET | `/products/:id` | Детали товара | — | Объект товара с размерами, ценами, изображениями |

### 2.3 Розыгрыш

| Метод | Путь | Описание | Тело/Параметры | Ответ |
|-------|------|----------|----------------|-------|
| GET | `/raffle/prizes` | Список призов текущего розыгрыша | — | `{ "items": [...], "raffle_id": ... }` |
| POST | `/raffle/spin` | Выполнить спин | `{ "prize_id": ..., "size": "..." }` (size опционально) | `{ "result": ["emoji","product","emoji"], "won": true, "prize": {...}, "promo_code": "..." }` или `{ "won": false, "result": [...] }` |

**Логика `/raffle/spin`:**
1. Проверка баланса Tezo ≥ 20 бонусов.
2. Списование 20 бонусов через Tezo API.
3. Уменьшение глобального счётчика спинов в БД.
4. Определение результата: по вероятностям или гарантированный выигрыш (если счётчик = 0).
5. При выигрыше: генерация промокода, добавление позиции в корзину пользователя с ценой 0 и привязка промокода.
6. Возврат результата (символы для слотов, флаг выигрыша, приз, промокод).

### 2.4 Корзина

| Метод | Путь | Описание | Тело | Ответ |
|-------|------|----------|------|-------|
| GET | `/cart` | Содержимое корзины | — | `{ "items": [...], "total_bonuses": N, "total_rubles": M }` |
| POST | `/cart/add` | Добавить позицию | `{ "product_id": ..., "size": "...", "quantity": 1 }` | `{ "success": true, "cart": {...} }` |
| PATCH | `/cart/items/:id` | Изменить количество | `{ "quantity": N }` | Обновлённая корзина |
| DELETE | `/cart/items/:id` | Удалить позицию | — | Обновлённая корзина |
| DELETE | `/cart` | Очистить корзину | — | `{ "success": true }` |

### 2.5 Заказы

| Метод | Путь | Описание | Тело | Ответ |
|-------|------|----------|------|-------|
| POST | `/orders` | Создать заказ | `{ "address": "...", "delivery_type": "courier" \| "pickup", "comment": "...", "promo_codes": ["..."] }` | `{ "order_id": ..., "payment_url": "..." }` или `{ "order_id": ..., "success": true }` (если оплата только бонусами) |

**Логика создания заказа:**
1. Валидация корзины, адреса (при курьере), промокодов для позиций 0 ₽.
2. Расчёт итога: бонусы + рубли.
3. Списование бонусов через Tezo API.
4. Создание заказа в БД.
5. Если есть рублёвая часть — создание платежа в ЮKassa, возврат `payment_url`.
6. Если только бонусы и промокоды — подтверждение заказа, отправка в супергруппу, ответ без payment_url.
7. Дублирование заказа в Telegram-супергруппу (создание темы или сообщения).

### 2.6 Вебхук ЮKassa

| Метод | Путь | Описание |
|-------|------|----------|
| POST | `/webhooks/yookassa` | Обработка уведомлений об оплате. При успешной оплате — обновление статуса заказа, отправка в супергруппу (если ещё не отправлено). |

---

## 3. API для веб-админки

**Базовый путь:** `/api/v1/admin`.  
**Авторизация:** JWT (или session) после входа по логину/паролю или привязке Telegram. Проверка роли пользователя на каждый запрос.

### 3.1 Авторизация

| Метод | Путь | Описание | Тело | Ответ |
|-------|------|----------|------|-------|
| POST | `/auth/login` | Вход | `{ "login": "...", "password": "..." }` или `{ "telegram_init_data": "..." }` | `{ "access_token": "...", "user": {...} }` |
| POST | `/auth/logout` | Выход | — | `{ "success": true }` |
| GET | `/auth/me` | Текущий пользователь и права | — | `{ "user": {...}, "roles": [...], "permissions": [...] }` |

### 3.2 Розыгрыш

| Метод | Путь | Описание | Тело/Параметры | Ответ |
|-------|------|----------|----------------|-------|
| GET | `/raffle` | Текущий розыгрыш (статус, счётчик, призы) | — | Объект розыгрыша |
| PATCH | `/raffle` | Обновить настройки (лимит спинов) | `{ "spins_until_win": N }` | Обновлённый розыгрыш |
| POST | `/raffle/repeat` | Повторить розыгрыш (сброс счётчика) | — | `{ "success": true }` |
| POST | `/raffle/new` | Создать новый розыгрыш | `{ "spins_until_win": N }` | Новый розыгрыш |
| GET | `/raffle/prizes` | Список призов | — | `{ "items": [...] }` |
| POST | `/raffle/prizes` | Добавить приз | FormData: image, name, has_sizes, sizes[], price_bonuses, probability | Созданный приз |
| GET | `/raffle/prizes/:id` | Детали приза | — | Объект приза |
| PATCH | `/raffle/prizes/:id` | Редактировать приз | FormData (частичное обновление) | Обновлённый приз |
| DELETE | `/raffle/prizes/:id` | Удалить приз | — | `{ "success": true }` |

### 3.3 Магазин (товары)

| Метод | Путь | Описание | Тело/Параметры | Ответ |
|-------|------|----------|----------------|-------|
| GET | `/products` | Список товаров | `?search=...&in_raffle=...&in_stock=...&sort=...` | `{ "items": [...], "total": N }` |
| GET | `/products/:id` | Детали товара | — | Объект товара |
| POST | `/products` | Создать товар | FormData: images[], name, has_sizes, sizes[], price_bonuses, price_rubles, discount_percent, in_raffle, stock | Созданный товар |
| PATCH | `/products/:id` | Обновить товар | FormData (частичное) | Обновлённый товар |
| DELETE | `/products/:id` | Удалить товар | — | `{ "success": true }` |

### 3.4 Загрузка изображений (S3)

| Метод | Путь | Описание | Тело | Ответ |
|-------|------|----------|------|-------|
| POST | `/upload/image` | Загрузить изображение в S3 | FormData: file | `{ "url": "https://...", "key": "..." }` |
| DELETE | `/upload/image` | Удалить изображение из S3 | `{ "key": "..." }` или `{ "url": "..." }` | `{ "success": true }` |

Загрузка вызывается при создании/редактировании товара или приза. Бэкенд сохраняет файл в S3, возвращает URL; фронтенд сохраняет URL в форме и отправляет его в PATCH/POST товара/приза.

### 3.5 Заказы

| Метод | Путь | Описание | Параметры | Ответ |
|-------|------|----------|------------|-------|
| GET | `/orders` | Список заказов | `?date_from=...&date_to=...&status=...` | `{ "items": [...], "total": N }` |
| GET | `/orders/:id` | Детали заказа | — | Объект заказа с позициями |

### 3.6 Обращения

| Метод | Путь | Описание | Тело/Параметры | Ответ |
|-------|------|----------|----------------|-------|
| GET | `/appeals` | Список обращений | `?category=...&status=...&date_from=...` | `{ "items": [...], "total": N }` |
| GET | `/appeals/:id` | Детали обращения (переписка) | — | Объект с сообщениями |
| POST | `/appeals/:id/reply` | Ответить на обращение | `{ "text": "..." }` | `{ "success": true }` — ответ уходит в бот и в тему супергруппы |

### 3.7 Пользователи и роли

| Метод | Путь | Описание | Тело | Ответ |
|-------|------|----------|------|-------|
| GET | `/admins` | Список админов бота (Telegram ID) | — | `{ "items": [...] }` |
| POST | `/admins` | Добавить админа | `{ "telegram_id": ... }` | `{ "success": true }` |
| DELETE | `/admins/:id` | Удалить админа | — | `{ "success": true }` |
| GET | `/roles` | Список ролей | — | `{ "items": [...] }` |
| POST | `/roles` | Создать роль | `{ "name": "...", "permissions": {...} }` | Созданная роль |
| PATCH | `/roles/:id` | Редактировать роль | `{ "name": "...", "permissions": {...} }` | Обновлённая роль |
| DELETE | `/roles/:id` | Удалить роль | — | `{ "success": true }` |

---

## 4. Telegram-бот

### 4.1 Обработчики

| Команда/событие | Действие |
|-----------------|----------|
| /start | Приветствие, кнопки «Оставить обращение» и «Потратить бонусы» (ссылка на Mini App) |
| «Оставить обращение» | Запрос категории (inline-кнопки), затем текста сообщения. После отправки — создание тикета в БД, пересылка в супергруппу (тема), ответ пользователю |
| «Потратить бонусы» | Открытие Mini App (WebApp кнопка или ссылка) |
| Ответ в теме супергруппы | Пересылка сообщения пользователю в личку бота (двусторонняя связь) |

### 4.2 Интеграция с API

- Бот использует общий API или внутренние сервисы для создания тикетов, заказов, получения данных.
- При создании заказа/обращения — бот отправляет сообщение в супергруппу (создаёт тему через Bot API, если поддерживается, или отправляет в общий чат с пометкой).

### 4.3 Админы бота

- Проверка `user.id` в списке админов из БД (таблица `admins`). ID 7533811917 — в конфиге по умолчанию при первом запуске/миграции.

---

## 5. Интеграции

### 5.1 Tezo API

- **Базовый URL:** из документации Tezo (Postman).
- **Методы:** получение баланса по карте/телефону; списание бонусов; регистрация (если есть).
- **Авторизация:** по документации (API key, Basic Auth и т.д.).
- **Обработка ошибок:** логирование, возврат понятных сообщений пользователю (карта не найдена, недостаточно бонусов).

### 5.2 ЮKassa

- **Создание платежа:** при оформлении заказа с рублёвой частью.
- **Вебхук:** подтверждение оплаты, обновление статуса заказа.
- **Идемпотентность:** проверка дублей уведомлений по `payment_id`.

### 5.3 S3

- **Bucket:** отдельный для изображений товаров/призов.
- **Структура ключей:** например `products/{product_id}/{uuid}.jpg`, `prizes/{prize_id}/{uuid}.jpg`.
- **Политика доступа:** чтение по URL (публичное или signed URL); запись только через бэкенд.
- **Форматы:** JPG, PNG. Ограничение размера (например, 5 МБ).

### 5.4 Telegram Bot API

- Отправка сообщений, создание тем в супергруппе (если API поддерживает).
- WebApp кнопка для открытия Mini App.

---

## 6. Логирование

| Уровень | Файл | Содержимое |
|---------|------|------------|
| ERROR | `logs/error.log` | Ошибки приложения, исключения, сбои интеграций |
| INFO | `logs/info.log` | Основные события: создание заказа, спин, привязка Tezo, вход в админку |
| DEBUG | `logs/debug.log` | Детальные запросы/ответы API, отладочная информация |

Ротация логов: по размеру или по дате (например, logrotate).

---

## 7. Резервное копирование БД

- Периодичность: по регламенту (например, ежедневно).
- Хранение: N последних копий (например, 7 дней).
- Инструмент: `pg_dump` или облачный бэкап PostgreSQL.

---

## 8. Безопасность

| Аспект | Требование |
|--------|------------|
| HTTPS | Обязательно для API и Mini App |
| Валидация initData | Проверка подписи Telegram Web App |
| JWT | Срок жизни токена (например, 24 ч), refresh при необходимости |
| CORS | Разрешить только домены Mini App и веб-админки |
| SQL-инъекции | Использование ORM/параметризованных запросов |
| Секреты | Хранение в конфиге/переменных окружения, не в коде |

---

## 9. Деплой

- **Сервер:** VPS или облако (указать ОС, версию Python).
- **Запуск:** systemd или Docker. Отдельные процессы: API, бот (или один процесс с asyncio).
- **Прокси:** Nginx перед API (reverse proxy, SSL).
- **Миграции:** выполнение Alembic при деплое.
